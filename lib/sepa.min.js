(function(t){function n(t){w=t}function e(t){F=!!t}function i(t){var n=0===t.indexOf("pain.008")?1:0;return parseInt(t.substr(-2),10)+n}function r(t){this._painFormat=t||T,this._type=O[this._painFormat],this._paymentInfo=[],this._xmlVersion=E,this._xmlEncoding=x,this.grpHdr=new o(this._painFormat)}function o(t){this._painFormat=t}function s(t){this._painFormat=t,this.method=0===t.indexOf("pain.001")?L.Transfer:L.DirectDebit,this._payments=[]}function a(t){this._painFormat=t,this._type=0===t.indexOf("pain.001")?M.Transfer:M.DirectDebit}function d(t){for(var n="",e=0,i=t.length;e<i;++e){var r=t.charCodeAt(e);r>=65&&r<=90?n+=(r-55).toString():r>=97&&r<=122?n+=(r-87).toString():r>=48&&r<=57&&(n+=t[e])}return n}function u(t){for(var n=0,e=0,i=t.length;e<i;++e)n=(10*n+parseInt(t[e],10))%97;return n}function h(t){var n=t.substr(4)+t.substr(0,4);return 1===u(d(n))}function m(t){var n=t.substr(4)+t.substr(0,2)+"00",e=u(d(n));return t.substr(0,2)+("0"+(98-e)).substr(-2,2)+t.substr(4)}function c(t){var n=t.substr(7)+t.substr(0,4);return 1===u(d(n))}function l(t){var n=t.substr(7)+t.substr(0,2)+"00",e=u(d(n));return t.substr(0,2)+("0"+(98-e)).substr(-2,2)+t.substr(4)}function p(t,n){if(!t)throw new Error(n)}function I(t,n,e){if(n.indexOf(t)<0)throw new Error(e+" must have any value of: "+n.join(" ")+"(found: "+t+")")}function f(t,n,e,i){if(null!==n&&t&&t.length<n||null!==e&&t&&t.length>e)throw new Error(i+" has invalid string length, expected "+n+" < "+t+" < "+e)}function y(t,n,e,i){if(t<n||t>e)throw new Error(i+" does not match range "+n+" < "+t+" < "+e)}function C(t,n){if(!h(t))throw new Error(n+' has invalid IBAN "'+t+'"')}function b(t,n){if(!c(t))throw new Error(n+' is invalid "'+t+'"')}function g(t,n){if(!t||isNaN(t.getTime()))throw new Error(n+" has invalid date "+t)}function D(t,n){if(t&&!t.match(/([A-Za-z0-9]|[+|?|/|\-|:|(|)|.|,|'| ]){1,35}/))throw new Error(n+" doesn't match sepa id charset type 1 (found: \""+t+'")')}function S(t,n){if(t&&!t.match(/([A-Za-z0-9]|[+|?|/|\-|:|(|)|.|,|']){1,35}/))throw new Error(n+" doesn't match sepa id charset type 2 (found: \""+t+'")')}function v(t,n){if("undefined"!=typeof document&&void 0!==document.implementation)return document.implementation.createDocument(t,n);var e=require("xmldom").DOMImplementation;return(new e).createDocument(t,n)}function _(t){var n;if("undefined"==typeof window){var e=require("xmldom").XMLSerializer;n=new e}else n=new window.XMLSerializer;return n.serializeToString(t)}function B(t,n,e){return function(){var i=arguments[0],r=e&&arguments[arguments.length-1],o=e?arguments.length-1:arguments.length;if(n||r||0===r){for(var s=1;s<o;++s)i=i.appendChild(t.createElementNS(t.documentElement.namespaceURI,arguments[s]));return e&&(i.textContent=r),i}return null}}var A="http://www.w3.org/2001/XMLSchema-instance",N="urn:iso:std:iso:20022:tech:xsd:",E="1.0",x="UTF-8",T="pain.008.001.02",w=".",F=!0,O={"pain.001.001.02":"pain.001.001.02","pain.001.003.02":"pain.001.003.02","pain.001.001.03":"CstmrCdtTrfInitn","pain.001.003.03":"CstmrCdtTrfInitn","pain.008.001.01":"pain.008.001.01","pain.008.003.01":"pain.008.003.01","pain.008.001.02":"CstmrDrctDbtInitn","pain.008.003.02":"CstmrDrctDbtInitn"};r.Types=O,r.prototype={_painFormat:null,grpHdr:null,_paymentInfo:[],_type:null,_xmlVersion:null,_xmlEncoding:x,addPaymentInfo:function(t){if(!(t instanceof s))throw new Error("Given payment is not member of the PaymentInfo class");t.id?t.id=this.grpHdr.id+w+t.id:t.id=this.grpHdr.id+w+this._paymentInfo.length,this._paymentInfo.push(t)},createPaymentInfo:function(){return new s(this._painFormat)},normalize:function(){for(var t=0,n=0,e=0,i=this._paymentInfo.length;e<i;++e)this._paymentInfo[e].normalize(),t+=this._paymentInfo[e].controlSum,n+=this._paymentInfo[e].transactionCount;this.grpHdr.controlSum=t,this.grpHdr.transactionCount=n},toXML:function(){this.normalize();var t=N+this._painFormat,n=v(t,"Document");n.xmlVersion=this._xmlVersion;var e=n.documentElement;e.setAttribute("xmlns:xsi",A),e.setAttribute("xsi:schemaLocation",N+this._painFormat+" "+this._painFormat+".xsd");var i=n.createElementNS(t,this._type);i.appendChild(this.grpHdr.toXML(n));for(var r=0,o=this._paymentInfo.length;r<o;++r)i.appendChild(this._paymentInfo[r].toXML(n));return n.documentElement.appendChild(i),n},toString:function(){var t=this.toXML(),n='<?xml version="'+t.xmlVersion+'" encoding="'+t.xmlEncoding+'"?>';return n+_(t)}},o.prototype={_painFormat:null,id:"",created:"",transactionCount:0,initiatorName:"",controlSum:0,batchBooking:!1,grouping:"MIXD",toXML:function(t){var n=B(t,!0,!0),e=t.createElementNS(t.documentElement.namespaceURI,"GrpHdr"),r=i(this._painFormat);return n(e,"MsgId",this.id),n(e,"CreDtTm",this.created.toISOString()),2===r&&n(e,"BtchBookg",this.batchBooking.toString()),n(e,"NbOfTxs",this.transactionCount),n(e,"CtrlSum",this.controlSum.toFixed(2)),2===r&&n(e,"Grpg",this.grouping),n(e,"InitgPty","Nm",this.initiatorName),e},toString:function(){return _(this.toXML())}};var L={DirectDebit:"DD",Transfer:"TRF"};s.PaymentInfoTypes=L,s.prototype={_painFormat:null,_payments:null,id:"",method:null,batchBooking:!1,grouping:"MIXD",controlSum:0,localInstrumentation:"CORE",sequenceType:"FRST",collectionDate:null,requestedExecutionDate:null,creditorId:"",creditorName:"",creditorStreet:null,creditorCity:null,creditorCountry:null,creditorIBAN:"",creditorBIC:"",debtorId:"",debtorName:"",debtorStreet:null,debtorCity:null,debtorCountry:null,debtorIBAN:"",debtorBIC:"",instructionPriority:"NORM",get transactionCount(){return this._payments.length},normalize:function(){for(var t=0,n=0,e=this._payments.length;n<e;++n)t+=this._payments[n].amount;this.controlSum=t},addTransaction:function(t){if(!(t instanceof a))throw new Error("Given Transaction is not member of the SepaTransaction class");t.id?t.id=this.id+w+t.id:t.id=this.id+w+this._payments.length,this._payments.push(t)},createTransaction:function(){return new a(this._painFormat)},validate:function(){var t=this.method===L.DirectDebit?"creditor":"debtor";I(this.localInstrumentation,["CORE","COR1","B2B"],"localInstrumentation"),I(this.sequenceType,["FRST","RCUR","OOFF","FNAL"],"sequenceType"),this.method===L.DirectDebit?g(this.collectionDate,"collectionDate"):g(this.requestedExecutionDate,"requestedExecutionDate"),b(this[t+"Id"],t+"Id"),f(this[t+"Name"],null,70,t+"Name"),f(this[t+"Street"],null,70,t+"Street"),f(this[t+"City"],null,70,t+"City"),f(this[t+"Country"],null,2,t+"Country"),C(this[t+"IBAN"],t+"IBAN"),f(this[t+"BIC"],[0,8,11],t+"BIC");var n=0===this[t+"BIC"].length||this[t+"BIC"].substr(4,2)===this[t+"IBAN"].substr(0,2);p(n,"country mismatch in BIC/IBAN"),f(this._payments.length,1,null,"_payments")},toXML:function(t){F&&this.validate();var n=B(t,!0,!1),e=B(t,!0,!0),r=t.createElementNS(t.documentElement.namespaceURI,"PmtInf");e(r,"PmtInfId",this.id),e(r,"PmtMtd",this.method),3===i(this._painFormat)&&(e(r,"BtchBookg",this.batchBooking.toString()),e(r,"NbOfTxs",this.transactionCount),e(r,"CtrlSum",this.controlSum.toFixed(2)));var o=n(r,"PmtTpInf");e(o,"SvcLvl","Cd","SEPA"),this.method===L.DirectDebit?(e(o,"LclInstrm","Cd",this.localInstrumentation),e(o,"SeqTp",this.sequenceType),e(r,"ReqdColltnDt",this.collectionDate.toISOString().substr(0,10))):e(r,"ReqdExctnDt",this.requestedExecutionDate.toISOString().substr(0,10));var s=this.method===L.DirectDebit?"creditor":"debtor",a=this.method===L.DirectDebit?"Cdtr":"Dbtr",d=n(r,a);if(e(d,"Nm",this[s+"Name"]),this[s+"Street"]&&this[s+"City"]&&this[s+"Country"]){var u=n(d,"PstlAdr");e(u,"Ctry",this[s+"Country"]),e(u,"AdrLine",this[s+"Street"]),e(u,"AdrLine",this[s+"City"])}if(e(r,a+"Acct","Id","IBAN",this[s+"IBAN"]),this[s+"BIC"]?e(r,a+"Agt","FinInstnId","BIC",this[s+"BIC"]):e(r,a+"Agt","FinInstnId","Othr","Id","NOTPROVIDED"),e(r,"ChrgBr","SLEV"),this.method===L.DirectDebit){var h=n(r,"CdtrSchmeId","Id","PrvtId","Othr");e(h,"Id",this.creditorId),e(h,"SchmeNm","Prtry","SEPA")}for(var m=0,c=this._payments.length;m<c;++m)r.appendChild(this._payments[m].toXML(t));return r},toString:function(){return _(this.toXML())}};var M={DirectDebit:"DrctDbtTxInf",Transfer:"CdtTrfTxInf"};a.TransactionTypes=M,a.prototype={_type:M.DirectDebit,id:"",end2endId:"",currency:"EUR",amount:0,purposeCode:null,mandateId:"",mandateSignatureDate:null,debtorName:"",debtorStreet:null,debtorCity:null,debtorCountry:null,debtorIBAN:"",debtorBIC:"",remittanceInfo:"",creditorName:"",creditorStreet:null,creditorCity:null,creditorCountry:null,creditorIBAN:"",creditorBIC:"",validate:function(){var t=this._type===M.Transfer?"creditor":"debtor";D(this.end2endId,"end2endId"),y(this.amount,.01,999999999.99,"amount"),p(this.amount==this.amount.toFixed(2),"amount has too many fractional digits"),f(this.purposeCode,1,4,"purposeCode"),S(this.mandateId,"mandateId"),g(this.mandateSignatureDate,"mandateSignatureDate"),f(this[t+"Name"],null,70,t+"Name"),f(this[t+"Street"],null,70,t+"Street"),f(this[t+"City"],null,70,t+"City"),f(this[t+"Country"],null,2,t+"Country"),C(this[t+"IBAN"],t+"IBAN"),I(this[t+"BIC"].length,[0,8,11],t+"BIC");var n=0===this[t+"BIC"].length||this[t+"BIC"].substr(4,2)===this[t+"IBAN"].substr(0,2);p(n,"country mismatch in BIC/IBAN"),f(this.remittanceInfo,null,140,"remittanceInfo")},toXML:function(t){F&&this.validate();var n=this._type===M.Transfer?"creditor":"debtor",e=this._type===M.Transfer?"Cdtr":"Dbtr",i=B(t,!0,!1),r=B(t,!1,!0),o=B(t,!0,!0),s=t.createElementNS(t.documentElement.namespaceURI,this._type),a=i(s,"PmtId");if(o(a,"InstrId",this.id),o(a,"EndToEndId",this.end2endId),this._type===M.DirectDebit){o(s,"InstdAmt",this.amount.toFixed(2)).setAttribute("Ccy",this.currency);var d=i(s,"DrctDbtTx","MndtRltdInf");o(d,"MndtId",this.mandateId),o(d,"DtOfSgntr",this.mandateSignatureDate.toISOString().substr(0,10)),this.ammendment?(o(d,"AmdmntInd","true"),o(d,"AmdmnInfDtls",this.ammendment)):o(d,"AmdmntInd","false")}else o(s,"Amt","InstdAmt",this.amount.toFixed(2)).setAttribute("Ccy",this.currency);this[n+"BIC"]?o(s,e+"Agt","FinInstnId","BIC",this[n+"BIC"]):o(s,e+"Agt","FinInstnId","Othr","Id","NOTPROVIDED");var u=i(s,e);if(o(u,"Nm",this[n+"Name"]),this[n+"Street"]&&this[n+"City"]&&this[n+"Country"]){var h=i(u,"PstlAdr");o(h,"Ctry",this.debtorCountry),o(h,"AdrLine",this.debtorStreet),o(h,"AdrLine",this.debtorCity)}return o(s,e+"Acct","Id","IBAN",this[n+"IBAN"]),o(s,"RmtInf","Ustrd",this.remittanceInfo),r(s,"Purp","Cd",this.purposeCode),s}},t.Document=r,t.validateIBAN=h,t.checksumIBAN=m,t.validateCreditorID=c,t.checksumCreditorID=l,t.setIDSeparator=n,t.enableValidations=e})("undefined"==typeof exports?this.SEPA={}:exports);